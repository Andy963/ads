#!/usr/bin/env bash
set -euo pipefail

branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")"
if [[ "$branch" == "main" ]]; then
  echo "ERROR: committing directly on 'main' is blocked. Switch to 'dev'." >&2
  exit 1
fi

# Lightweight secret scan on staged content to catch obvious leaks before they hit GitGuardian.
# - Scans only staged files (not the working tree).
# - Prints file/line and rule id, never the matched secret.
if command -v python3 >/dev/null 2>&1; then
python3 - <<'PY'
import os
import re
import subprocess
import sys

def run(*args: str) -> str:
    return subprocess.check_output(args, text=True)

rules: list[tuple[str, re.Pattern[str]]] = [
    ("aws_access_key_id", re.compile(r"\b(AKIA|ASIA)[0-9A-Z]{16}\b")),
    ("github_token", re.compile(r"\b(ghp_[A-Za-z0-9]{36}|github_pat_[A-Za-z0-9_]{20,})\b")),
    ("slack_token", re.compile(r"\bxox[baprs]-[A-Za-z0-9-]{10,}\b")),
    ("google_api_key", re.compile(r"\bAIza[0-9A-Za-z\-_]{35}\b")),
    ("tavily_api_key", re.compile(r"\btvly-[A-Za-z0-9]{20,}\b")),
    ("openai_like_api_key", re.compile(r"\bsk-[A-Za-z0-9]{32,}\b")),
    ("private_key_block", re.compile(r"-----BEGIN (RSA|OPENSSH|EC|DSA) PRIVATE KEY-----")),
    ("telegram_bot_token", re.compile(r"\b[0-9]{8,12}:[A-Za-z0-9_-]{30,}\b")),
]

try:
    names = run("git", "diff", "--cached", "--name-only", "--diff-filter=ACMRT").splitlines()
except Exception:
    sys.exit(0)

findings: list[tuple[str, int, str]] = []

for path in names:
    if not path or path.startswith(".git/"):
        continue

    # Read the staged blob (not the working tree).
    try:
        blob = subprocess.check_output(["git", "show", f":{path}"])
    except Exception:
        continue

    # Skip very large files to keep commit latency predictable.
    if len(blob) > 1_000_000:
        continue

    try:
        text = blob.decode("utf-8")
    except UnicodeDecodeError:
        continue

    for rule_id, rx in rules:
        m = rx.search(text)
        if not m:
            continue
        line = text.count("\n", 0, m.start()) + 1
        findings.append((path, line, rule_id))

if findings:
    print("ERROR: potential secret detected in staged content.", file=sys.stderr)
    for path, line, rule_id in findings:
        print(f"- {path}:{line} ({rule_id})", file=sys.stderr)
    print("Fix the leak (revoke/rotate if needed) and amend the commit.", file=sys.stderr)
    sys.exit(1)
PY
fi
