# ADS 项目开发规则

本文档定义了 ADS (AI-Driven Specification) 项目的开发约束和规范。AI 助手在工作时必须严格遵守这些规则。

## 🚫 严格禁止规则 (违反任一条立即停止)

这些规则是绝对的，违反任何一条都必须立即停止操作并向用户报告：

### 1. 禁止删除数据库文件

**规则**: 不得删除任何数据库文件，包括但不限于：
- `.db` 文件
- `.sqlite` / `.sqlite3` 文件
- `.ads/ads.db` 工作空间数据库
- `.ads/index.json` (lite 模式的索引文件)

**原因**: 数据库包含所有工作流、节点和历史记录，删除会导致数据永久丢失。

**正确做法**:
- 如需清理数据，使用 ADS 提供的清理命令
- 如需重置，使用 `ads init --force` 重新初始化

---

### 2. 禁止自动提交到 Git

**规则**: 不得执行以下 Git 命令：
- `git commit`
- `git push`
- `git add` (除非用户明确要求)

**原因**: 代码提交应由用户控制，自动提交可能导致错误代码进入版本库。

**正确做法**:
- 生成代码后，提示用户检查
- 告知用户可以使用 `git status` 和 `git diff` 查看变更
- 让用户手动决定是否提交

**例外**: 当用户明确要求 "帮我提交" 或 "commit this" 时才可以执行。

---

### 3. 禁止写入 Co-authored-by 标签

**规则**: Git commit message 中不得添加 `Co-authored-by` 标签。

**原因**: 
- ADS 是辅助工具，不应署名为共同作者
- 保持 Git 历史清晰，只记录人类作者

**正确做法**:
- 提交信息只包含用户作为作者
- 如果用户想记录 AI 辅助，可以在 commit message body 中说明

---

### 4. 禁止在 docs/ 目录外创建文档

**规则**: 所有项目文档必须存放在 `docs/` 目录下，特别是：
- 工作流文档: `docs/specs/<workflow_id>/`
- 技术文档: `docs/`
- API 文档: `docs/api/`

**原因**: 统一文档位置，便于管理和查找。

**正确做法**:
```
docs/
├── specs/              # 工作流规范文档
│   ├── bug_abc123/
│   │   ├── bug_report.md
│   │   ├── bug_analysis.md
│   │   └── bug_fix.md
│   └── feature_xyz789/
│       └── ...
├── architecture/       # 架构文档
├── api/               # API 文档
└── guides/            # 使用指南
```

**例外**: 
- `README.md` 可以放在项目根目录
- `.claude/commands/*.md` 是 slash commands 定义，不属于项目文档

---

### 5. 禁止在根目录下随意创建脚本

**规则**: 不得在项目根目录创建临时脚本文件，如：
- `test.py`
- `debug.js`
- `temp_script.sh`
- `test_*.py` (除非是测试框架的标准位置)

**原因**: 保持项目根目录整洁，避免临时文件混入版本控制。

**正确做法**:
- 测试脚本放在 `ads/tests/` 或 `tests/` 目录
- 临时调试脚本放在 `/tmp/` 或系统临时目录
- 工具脚本放在 `scripts/` 目录

---

## 📋 开发规范

### 工作流管理

1. **工作流文档结构**
   - 每个工作流有独立目录: `docs/specs/<workflow_id>/`
   - 每个步骤对应一个 markdown 文件
   - 文件名与步骤名称一致

2. **节点状态管理**
   - `draft`: 草稿状态，内容可以修改
   - `finalized`: 已定稿，创建版本快照
   - 只有 draft 节点可以被 commit（定稿）

3. **工作流自动流转**
   - commit 一个步骤后，自动创建下一步
   - 遵循模板定义的步骤顺序
   - 不能跳过步骤

### ADS 工具使用

优先使用 ADS MCP 工具，而不是直接操作文件或数据库：

**正确**:
```python
# 使用 MCP 工具
create_node(...)
update_node(...)
finalize_step(...)
```

**错误**:
```python
# 直接操作数据库
db.execute("INSERT INTO nodes ...")
# 直接写文件
open("docs/specs/xxx.md", "w").write(...)
```

### 命令规范

- 使用 ADS 命令前缀: `ads.xxx` 或 `/ads.xxx`
- 类似 git 的工作流: `ads.new`, `ads.status`, `ads.commit`, `ads.checkout`
- 所有命令支持 `workspace_path` 参数

---

## 🔧 技术规范

### 编码规范

1. **Python 代码**
   - 遵循 PEP 8
   - 使用 type hints
   - 函数和类必须有 docstring

2. **数据库操作**
   - 使用 SQLAlchemy ORM
   - 不直接执行原始 SQL
   - 所有操作在事务中进行

3. **错误处理**
   - 捕获具体异常类型
   - 提供有意义的错误消息
   - 记录错误日志

### 测试规范

1. **测试文件位置**
   - 单元测试: `ads/tests/test_*.py`
   - 集成测试: `ads/tests/integration/`

2. **测试覆盖**
   - 所有公开 API 必须有测试
   - 关键业务逻辑必须有测试

---

## 📝 文档规范

### Markdown 格式

1. **文件结构**
   ```markdown
   # 标题
   
   ## 概述
   简要说明
   
   ## 详细内容
   ...
   
   ## 相关链接
   - [相关文档](./related.md)
   ```

2. **代码块**
   - 使用语言标识: \`\`\`python, \`\`\`json
   - 提供注释说明
   - 包含输入输出示例

3. **链接规范**
   - 内部文档使用相对路径
   - 外部链接使用绝对 URL
   - 检查链接有效性

---

## ✅ 检查清单

在执行任何操作前，AI 应该检查：

- [ ] 是否需要删除数据库文件？→ 如果是，停止
- [ ] 是否需要执行 git commit/push？→ 如果是，询问用户
- [ ] 是否在 docs/ 外创建文档？→ 如果是，移到 docs/
- [ ] 是否在根目录创建脚本？→ 如果是，移到合适目录
- [ ] 是否遵循工作流规则？→ 检查步骤顺序
- [ ] 是否使用 ADS 工具？→ 优先使用 MCP 工具

---

## 📞 问题处理

如果遇到以下情况，应该询问用户：

1. **规则冲突**: 用户要求与规则冲突时，说明原因并建议替代方案
2. **不确定操作**: 可能影响数据完整性的操作
3. **需要权限**: 需要文件系统或数据库写权限的操作
4. **多种方案**: 有多种实现方式时，列出选项让用户选择

---

## 🔄 规则更新

此规则文件可以由用户修改和扩展：

1. **位置**: `.ads/rules.md`
2. **版本**: 跟随工作空间，独立于全局模板
3. **优先级**: 工作空间规则 > 全局模板规则

修改规则后，AI 会在下次读取规则时生效。

---

**版本**: 1.0  
**最后更新**: 2025-01-13
