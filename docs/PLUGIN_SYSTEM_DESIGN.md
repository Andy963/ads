# ADS 插件系统设计方案

## 一、核心目标

**让 AI 生成符合特定场景规范的代码**

问题：
- AI 自由发挥容易偏离规范
- 不同场景（FastAPI/React/Go）的最佳实践差异大
- ADS 核心不应该内置所有场景知识

解决：
- 通过插件系统扩展场景支持
- 插件按需安装，避免膨胀
- 社区可贡献插件

---

## 二、插件提供的三个核心功能

### 1. 流程定义

**功能：** 定义特定场景的开发流程

**示例：** FastAPI CRUD 开发流程

```
API 设计 → 数据模型 → 路由实现 → 测试
```

**格式：** YAML 配置文件

**作用：**
- 告诉 ADS 这个场景包含哪些步骤
- 定义步骤的依赖关系
- 用于自动创建工作流

---

### 2. 模板定义

**功能：** 定义每个节点应该包含什么内容

**示例：** API 设计节点模板

```markdown
## 端点列表
- POST /users - 创建用户
- GET /users - 获取用户列表
- ...

## 请求/响应格式
- 请求体：JSON
- 响应格式：JSON
- ...

## 错误处理
- 400：参数错误
- 404：资源不存在
- ...
```

**格式：** Markdown 模板

**作用：**
- 约束 AI 输出的结构
- 确保内容完整性
- 作为提示词的一部分

---

### 3. 参照示例

**功能：** 给 AI 看的参考代码

**示例：** User CRUD 完整实现

包含：
- Pydantic 模型定义
- FastAPI 路由实现
- 错误处理示例
- 最佳实践说明

**格式：** 实际代码文件 + 说明文档

**作用：**
- AI 生成时参考这些示例
- "按照这个例子写一个类似的"
- 确保代码风格一致

---

## 三、插件架构

### 3.1 核心原则

- **核心轻量**：ADS 只提供插件机制，不内置场景
- **独立包**：每个插件是独立的 Python 包
- **按需安装**：用户只装需要的插件
- **简单接口**：插件开发门槛低

### 3.2 插件结构

```
ads-plugin-fastapi/              # 独立 Python 包
├── setup.py                     # 包配置
├── ads_plugin_fastapi/
│   ├── __init__.py             # 插件入口
│   ├── workflows/              # 1. 流程定义
│   │   └── fastapi_crud.yaml
│   ├── templates/              # 2. 模板定义
│   │   ├── api_design.md
│   │   ├── data_model.md
│   │   └── router_impl.md
│   └── references/             # 3. 参照示例
│       ├── user_crud_example.py
│       └── best_practices.md
```

### 3.3 插件接口

插件需要实现的方法：
- `get_metadata()` - 返回插件信息
- `get_workflow_templates()` - 返回流程定义
- `get_node_templates()` - 返回节点模板
- `get_references()` - 返回参照示例

### 3.4 插件发现机制

使用 Python entry_points 自动发现已安装的插件

---

## 四、工作流程

### 用户视角（验证阶段）

1. **插件已内置**
   - 开发阶段插件在代码目录中
   - 无需安装

2. **创建工作流**
   - 选择模板：fastapi_crud
   - 自动创建节点：API设计 → 数据模型 → 路由实现

3. **AI 生成内容**
   - AI 看到节点模板（知道该写什么）
   - AI 看到参照示例（知道怎么写）
   - 生成符合规范的内容

4. **用户修改和定稿**
   - 可以继续对话修改
   - 定稿后自动流转到下一步

### 技术流程

1. **插件加载**
   - ADS 启动时自动发现插件
   - 加载所有已安装插件的配置

2. **工作流创建**
   - 从插件读取流程定义
   - 创建对应的节点和边

3. **内容生成**
   - 从插件读取节点模板
   - 从插件读取参照示例
   - 构造 AI 提示词
   - AI 基于模板和示例生成内容

4. **流程流转**
   - 节点定稿触发下游节点创建
   - 重复生成过程

---

## 五、实施计划

### 当前状态：验证阶段

**目标：** 验证插件系统的可行性，不考虑发布

**不做的事情：**
- ❌ 发布到 PyPI
- ❌ entry_points 自动发现
- ❌ 质量门检查
- ❌ 插件市场

### Step 1：插件接口定义（1-2天）

**目录结构：**
```
ads/
└── plugins/
    ├── __init__.py
    ├── interface.py      # Plugin 基类
    ├── loader.py         # 插件加载器
    └── registry.py       # 插件注册表
```

**核心内容：**
- Plugin 抽象基类
- 定义三个核心方法：
  - `get_workflow_templates()` - 返回流程定义
  - `get_node_templates()` - 返回节点模板  
  - `get_references()` - 返回参照示例

**验证标准：**
- 接口定义清晰
- 类型注解完整
- 文档字符串完善

### Step 2：FastAPI 插件实现（2-3天）

**插件位置：** 独立目录（不内置在 ads/ 中）

**目录结构：**
```
ads-plugin-fastapi/           # 独立插件目录
├── __init__.py
├── plugin.py                 # 插件实现
├── workflows/
│   └── fastapi_crud.yaml     # 流程定义
├── templates/
│   ├── api_design.md         # API设计模板
│   ├── data_model.md         # 数据模型模板
│   └── router_impl.md        # 路由实现模板
└── references/
    ├── user_crud_example.py  # User CRUD 完整示例
    └── best_practices.md     # 最佳实践说明
```

**场景选择：** FastAPI CRUD
- **节点1**：API 设计（定义端点和数据格式）
- **节点2**：数据模型（Pydantic schemas）
- **节点3**：路由实现（FastAPI router + CRUD）

**验证标准：**
- 插件能被正确加载
- 能读取到所有配置文件
- 三个功能完整实现

### Step 3：集成验证（1-2天）

**验证内容：**
- 插件加载器能找到并加载 FastAPI 插件
- 能正确解析 YAML 流程定义
- 能读取节点模板内容
- 能读取参照示例文件

**暂不验证：**
- 与 auto_workflow.py 的集成
- AI 提示词生成
- 完整工作流创建

**成功标准：**
- 代码运行无报错
- 能打印出插件的所有配置
- 为后续集成做好准备

### Step 4：后续规划

**如果验证成功，下一步：**
1. 集成到 auto_workflow 引擎
2. 在 AI 提示词中使用参照示例
3. 测试完整的工作流创建和流转

**如果需要调整：**
- 根据验证结果调整接口设计
- 优化插件结构
- 补充文档

---

## 六、AI 生成触发机制（后续集成时考虑）

### 5.1 核心原则

**只在"即将生成实现方案文档"时，才加载插件的模板和示例**

### 5.2 节点性质说明

1. **requirement** - 需求文档（用户需求描述）
2. **design** - 设计文档（架构设计、技术选型）
3. **implementation** - **实现方案文档**（详细的实现步骤、API设计、数据模型等）
4. **实际代码** - 基于 implementation 文档生成的代码文件

### 5.3 触发时机

#### ❌ requirement → design 定稿时

**不加载插件模板**

原因：
- requirement 和 design 都是高层次的文档
- 此时不涉及具体的技术实现细节
- 不需要插件的约束

#### ✅ design → implementation 定稿时

**加载插件模板和参考示例**

原因：
- AI 要生成 implementation 文档
- 需要按照插件定义的规范来写
- 确保 implementation 文档包含完整的技术细节

结果：
- implementation 文档中包含插件定义的结构
- 例如：API 端点列表、请求/响应格式、数据模型、错误处理等
- 这些内容成为后续生成代码的依据

#### 💡 implementation 文档完成后

- 基于这个规范文档去生成实际代码
- 可以追溯回 implementation 文档查看当时的设计决策
- 保证了可追溯性

### 5.4 插件配置

插件在 YAML 配置中声明自己适用于哪些节点类型：

```yaml
# ads-plugin-fastapi/workflows/fastapi_crud.yaml
metadata:
  target_node_types:
    - implementation
    - test
```

**好处：**
- **灵活性**：不同插件可以声明不同的目标节点
- **可扩展**：未来可能有插件需要在其他节点也加载模板
- **解耦**：ADS 核心不需要硬编码节点类型判断

### 5.5 技术实现流程

从 `ads/graph/auto_workflow.py` 的 `on_node_finalized()` 方法触发：

1. 用户执行 `/ads.commit` 定稿当前节点
2. `finalize_helper.py` 完成定稿（保存版本历史）
3. `auto_workflow.py` 的 `on_node_finalized()` 被触发
4. **检查下游节点类型**：
   - 如果下游节点在插件的 `target_node_types` 中
   - 加载插件的模板和参考示例
   - 构造 AI 提示词
   - 调用 AI 生成下游节点的草稿内容
5. 创建下游节点，填入 AI 生成的 `draft_content`

### 5.6 可追溯性保证

**问题：** AI 生成的内容如何追溯到使用了哪个插件的哪个模板？

**解决：**
- 在 `Node.node_metadata` 中记录：
  ```json
  {
    "plugin_name": "ads-plugin-fastapi",
    "plugin_version": "0.1.0",
    "template_used": "implementation",
    "references_used": ["user_crud_example.py"]
  }
  ```
- 在 implementation 文档的开头自动添加注释：
  ```markdown
  <!-- 此文档基于插件 ads-plugin-fastapi v0.1.0 生成 -->
  <!-- 使用模板: templates/implementation.md -->
  <!-- 参考示例: references/user_crud_example.py -->
  ```

---

## 七、可扩展性（未来规划）

### 第一阶段：插件系统基础

**核心功能：**
- 插件接口定义
- 插件加载器
- 插件注册表

**不包含：**
- 质量门检查（太复杂，后续考虑）
- 插件市场（暂不需要）

### 第二阶段：第一个官方插件

**选择场景：** FastAPI CRUD

**包含内容：**
1. 流程定义：API设计 → 数据模型 → 路由实现
2. 节点模板：3个 Markdown 模板
3. 参照示例：1个完整的 User CRUD 实现

**工作量：** 1-2周

### 第三阶段：文档和推广

**内容：**
- 插件开发指南
- 使用文档
- 示例插件模板

---

## 八、关键设计决策

### 为什么不做质量门？

**原因：**
- 参照示例已经能约束 AI
- 代码静态分析实现复杂
- 维护成本高

**结论：**
- MVP 阶段不做
- 可以后续作为可选功能

### 为什么用独立目录？

**验证阶段考虑：**
- 不内置在 ads/ 中，避免污染核心代码
- 独立目录便于开发和调试
- 暂不做 pip 包，简化验证流程

**后续可以：**
- 制作成独立 Python 包
- 发布到 PyPI
- 使用 entry_points 自动发现

**当前做法：**
- 手动指定插件路径加载
- 在代码中 import 插件

### 为什么不做插件市场？

**原因：**
- MVP 阶段不需要
- 用户可以直接 pip install
- PyPI 已经是包管理器

**结论：**
- 暂不实现
- 未来可以做插件列表页面

### 支持更多场景

**只需：** 创建新插件包

示例：
- ads-plugin-react - React 组件开发
- ads-plugin-go-gin - Go Web 开发
- ads-plugin-ddd - DDD 建模

### 支持企业私有场景

**企业可以：**
- 开发私有插件
- 发布到内部 PyPI
- 团队内部共享

### 支持社区贡献

**社区可以：**
- Fork 官方插件模板
- 开发新场景插件
- 发布到 PyPI

---

## 九、总结

### 核心价值

- ✅ 通过三个功能约束 AI 输出
- ✅ 核心保持轻量，避免膨胀
- ✅ 按需安装，用户友好
- ✅ 易于扩展，社区友好

### 实施成本

- ✅ 5-7天完成验证
- ✅ 接口 + 插件 + 基础验证
- ✅ 为后续完整集成做准备

### 风险

- ⚠️ 插件接口设计需要慎重
- ⚠️ 需要良好的文档支持
- ⚠️ 社区生态需要时间

### 验证阶段目标

- ✅ 插件接口设计合理
- ✅ FastAPI 插件实现完整
- ✅ 加载机制工作正常
- ✅ 为完整集成铺平道路

### 不在验证范围

- ❌ 与工作流引擎的完整集成
- ❌ AI 提示词生成测试
- ❌ 端到端工作流测试
- ❌ PyPI 发布准备

这些留待验证成功后进行。
