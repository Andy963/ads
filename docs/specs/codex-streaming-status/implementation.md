# Codex 流式状态集成实施计划

## 1. 工作包拆解
1. **依赖升级与配置**
   - 将 `@openai/codex-sdk` 升级至支持 `runStreamed()` 的版本。
   - 在 `resolveCodexConfig` 中新增流式相关配置项（环境变量解析）。
2. **CodexSession 重构**
   - 抽取 `ensureThread()`。
   - 实现 `runStreamed()` 与事件订阅/广播机制。
   - 调整 `send()` 默认走流式，保留非流式回退。
3. **事件映射层**
   - 新建模块封装 Codex→Agent 事件映射与节流策略。
   - 单元测试覆盖关键信号。
4. **CLI 状态展示**
   - 在 `handleCodexInteraction` 中订阅事件，实时更新终端状态行。
   - 完成度：状态行、总结输出、错误处理。
5. **日志扩展**
   - `ConversationLogger` 新增 `logEvent()`，输出 JSONL。
   - 确保日志写入不会阻塞主流程。
6. **回退与容错**
   - 处理流式调用失败的降级逻辑。
   - 对非流式模式进行回归测试。

## 2. 时间规划
- **第 1 天**：依赖升级、配置解析、CodexSession 架构调整。
- **第 2 天**：事件映射层及单元测试；CLI 状态行初稿。
- **第 3 天**：日志扩展、错误处理、回退路径。
- **第 4 天**：集成测试（含 Mock 事件与真实调用）；整理变更。

## 3. 测试计划
- **单元测试**：
  - 事件映射函数输入典型 Codex 事件，验证阶段与文案。
  - `CodexSession` 在流式/非流式模式下的行为（mock 线程）。
- **集成测试**：
  - 使用 Mock Codex 客户端重放事件，验证 CLI 输出顺序与节流效果。
  - 可选：在沙箱凭证下触发真实长任务，观察阶段变更与日志输出。
- **回归测试**：
  - `/ads.new`、`/ads.status` 等命令不受影响。
  - 确认禁用流式模式时仍按旧流程输出。

## 4. 发布与回滚
- 发布步骤：
  1. 合并代码并发布新版本（预计 minor 版本）。
  2. 更新发布说明，提示新增流式状态能力及配置项。
  3. 内部验证后推广到全部用户。
- 回滚策略：
  - 通过环境变量 `ADS_CODEX_STREAMING=0` 快速禁用新功能。
  - 若需彻底回退，可恢复到前一个版本的 `CodexSession` 实现。

## 5. 风险与缓解措施
- **事件过多导致输出刷屏**：采用 200ms 节流，并在日志中保存完整细节。
- **SDK 或 API 兼容问题**：上线前在 CI 配置中固定 SDK 版本，部署时进行预检查。
- **日志文件膨胀**：先行支持按会话文件输出，并在后续迭代增加轮转策略。

## 6. 依赖与协作
- 依赖 AI 平台团队提供的最新 Codex SDK。
- 与产品/设计协作确认阶段文案。
- 与 DevOps 团队确认日志保留策略与监控指标。
