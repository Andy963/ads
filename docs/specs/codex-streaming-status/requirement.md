# Codex 流式状态集成需求说明

## 1. 文档概览
- 版本：v0.1
- 状态：Draft（待评审）
- 作者：ADS 开发小组
- 审阅人：待指派
- 期望上线：下一次 ADS CLI 小版本

## 2. 背景与现状
- ADS CLI 目前通过 `CodexSession.send()` 调用 `thread.run()`，只在发送请求后输出 “⌛ Codex 正在思考...”，直到得到最终回复。
- 当 Codex 在执行读取文件、编辑代码或调用工具等过程时，用户无法获取任何进度回馈。
- Codex SDK 已提供 `runStreamed()`，可返回包含 `item.*`、`turn.*`、`tool.*` 等事件的流式接口。

## 3. 用户痛点
- 无法判断 Codex 是否仍在工作、卡住或失败，造成等待焦虑。
- CLI 和潜在的 ADS UI 都缺乏可视化状态，阻碍进一步的体验优化。
- 失败时只得到最终错误文案，缺乏足够上下文以便排查。

## 4. 目标
1. 在 CLI 端实时呈现 Codex 处理阶段（至少涵盖“解析上下文 / 编辑 / 调用工具 / 运行命令 / 响应 / 完成 / 错误”）。
2. 提供结构化事件数据接口，便于未来 UI 或自动化订阅。
3. 维持既有 `send()` 使用方式的兼容性，不要求现有调用方改动。

## 5. 成功指标
- 90% 以上耗时超过 10 秒的请求，会呈现至少一次阶段更新。
- 工具调用或命令执行事件出现后 1 秒内，CLI 能显示对应状态。
- 失败场景在 2 秒内输出错误类型，并附带关键信息以便排查。

## 6. 非目标
- 不改动工作流模板、系统提示词与输出文案规则。
- 不在本次交付实现 UI 端（仅提供基础接口和 CLI 展示）。
- 结构化输出 schema 与图像输入仅预留挂点，不默认启用。

## 7. 业务与技术约束
- 必须兼容当前 Node.js 运行环境（>=18），并依赖最新 `@openai/codex-sdk`。
- CLI 输出需保持简洁，避免大量滚屏。
- 落地后仍需支持非流式调用（环境变量可禁用）。

## 8. 用户场景
1. **CLI 长任务**：开发者询问“请诊断测试失败”，过程中看到阶段从“解析上下文”到“运行测试”，明确 Codex 正在推进。
2. **外部集成**：MCP 或其他调用方复用 `CodexSession`，订阅事件流，用于 UI 进度条或中断按钮。
3. **错误排查**：当网络或 API 失败时，日志记录事件序列，帮助工程师定位卡点。

## 9. 待确认事项
- 阶段标签的中文文案是否需要产品团队审批。
- 日志保留策略（按天 / 按工作流拆分）。
- 是否需要提供用户可触发的 cancel/abort 能力。
