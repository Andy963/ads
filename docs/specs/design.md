# ADS 单一工作流设计文档

## 1. 文档概览
- 版本：v0.1
- 状态：Draft（待技术负责人评审）
- 作者：ADS 流程整合小组
- 审阅人：{待指派}
- 关联需求：docs/specs/requirement.md（统一三步工作流需求）
- 关联实施计划：待生成（实施阶段使用 implementation_template.md）

## 2. 系统身份与语境
- 身份定位：ADS 是面向开发者的 AI 协作伙伴，负责在所有任务类型下维持统一的提示词与流程约束。
- 语境说明：当前仓库包含 CLI 与工作流服务实现，使用 `src/graph/config.yaml` 定义多套工作流模板，`src/workflow/templateService.ts` 提供模板创建能力。
- 与用户的关系设定：ADS 以伙伴身份提供建议与操作指引，用户（工程师、测试、运维）仍掌控最终执行。

## 3. 能力模型
- 支持的技能与场景：
  - 解析单一三步工作流（需求→方案→实施）并生成节点、提示词与任务清单。
  - 为不同任务类型（缺陷、功能、运维等）提供统一入口与同结构输出。
  - 结合项目上下文输出可执行命令、代码片段、验证步骤。
- 明确的限制与拒绝策略：
  - 不再根据“standard/feature/bugfix”等模板分支行为；在 CLI `/ads.new` 中引导用户直接使用单一工作流。
  - 对额外合规/安全需求提供附录链接，避免在主体流程中回退到旧模板分流。

## 4. 规则集设计
- 安全与合规：复用需求文档中的条目，禁止涉敏话题、泄露系统信息，使用占位符处理 PII。
- 行为准则：统一拒绝恶意请求、不评论第三方实现、将执行日志视为真实结果等；设计中需确保提示词在所有路径都强调这一点。
- 质量标准：所有模板与服务返回的命令/代码必须可直接运行，语法严格；针对失败场景需提示备用方案。

## 5. 响应风格
- 语气：专业、友好、直接，强调“一套流程解决全部需求”。
- 表达方式：先结论后细节，默认使用项目符号或编号列表；必要时使用代码块展示命令。
- 互动策略：遇到用户提及旧流程或特例时，主动说明新流程步骤并给出迁移指引；避免重复输出。

## 6. 提示词与文档结构
- 身份段落：引用系统提示中对 ADS 身份的描述（与 requirements 中保持一致）。
- 能力段落：列出统一工作流下可提供的技能点，强调“单一入口 + 三步流程”。
- 规则段落：合并安全、拒绝策略、执行日志处理、代码可执行性要求。
- 响应风格段落：说明语气、格式、交互节奏。
- 系统信息段落：指明当前运行环境为 Linux/WSL2，提醒命令格式。
- 平台/命令指南：保持 Windows CMD 与 WSL 的差异说明，目前仓库已有相关描述，可抽取再利用。
- 文档生成与目录结构：
  - 工作流实例写入 `docs/specs/{timestamp}-{slug}/` 子目录（或同等命名规则），确保多次创建不会互相覆盖。
  - Step 1：以 `templates/requirements_template.md` 作为需求模板生成 `requirement.md`，记录具体工作项需求。
  - Step 2：以 `templates/design_template.md` 作为设计模板生成 `design.md`，说明方案与交互设计。
  - Step 3：以 `templates/implementation_template.md` 作为实施模板生成 `implementation.md`，列出执行与验证清单。
  - CLI `/ads.new` 调用工作流服务时，通过 `getWorkspaceSpecsDir` 创建带时间戳和 slug 的新目录，复制模板占位并等待用户/自动化逐步补全。

## 7. 交互流程
- Step 1 需求收集与意图澄清：统一入口（CLI / UI）调用时，要求用户提供需求背景、目标、范围、干系人与依赖；设计在模板中提供必填字段验证。
- Step 2 方案与计划对齐：在一个文档段落中呈现设计决策、影响、任务拆分、验证计划；接口返回时包含结构化字段，供前端或 CLI 展示。
- Step 3 实施与收尾回传：使用单一清单跟踪实施进展、验证凭证、回滚/复盘记录；完成后将所有链接与附件归档到统一目录。
- 适配策略：采用完全人工驱动的协作流程。`/ads.new` 只初始化工作流与占位文档，后续需求、设计、实施内容需在多轮讨论与评审后由用户更新 `/ads.add`、`/ads.commit` 完成，每一步都引用同一工作流模板。

## 8. 工具与命令策略
- 常用工具/命令：沿用现有 CLI（例如 `/ads.new`）；在新流程下 `/ads.new` 不再要求用户指定模板类型，后台默认创建统一工作流。
- 平台约束：命令示例需适配 WSL2/Linux；若需要 Windows CMD 样例，放入附录。
- 自动化或钩子：保持现有 Hooks 机制，可新增在保存需求/设计/实施文档后触发校验统一模板的 hook。

## 9. 安全与监控
- 风险清单：
  - 残留旧模板配置或文档，导致用户误用。
  - 用户绕过统一模板写入历史结构。
  - 流程推广初期认知不一致。
- 缓解措施：
  - 移除旧模板与别名，仅保留统一模板配置。
  - 在模板生成入口增加校验（模板数量 ≠1 时立即告警并引导恢复）。
  - 发布迁移指引，确保所有入口文档同步更新。
- 审计与告警：
  - 通过日志统计模板创建请求的模板 ID，出现非 unified 时告警。
  - 在试点期间开启 debug 日志，确认三步节点生成顺序正确。

## 10. 测试与验证
- 场景用例：
  - CLI 创建工作流并逐步补充需求/设计/实施内容。
  - 多次往返讨论后再次更新 `/ads.add`、`/ads.commit` 的流程测试。
  - 旧模板文件被检测并拒绝创建。
- 评估指标：
  - 模板创建成功率 ≥ 99%。
  - 用户反馈表达统一流程易于理解与讨论。
  - 无遗留旧模板节点的工单。
- 验证流程：
  - 单元测试：覆盖 `templateService` 新逻辑。
  - 集成测试：运行示例仓库脚本，确保生成的节点文件正确。
  - 手工验证：根据实施计划 checklist 逐项核对。

## 11. 变更与发布
- 变更触发条件：需求通过评审且实施计划获得批准。
- 发布步骤：
  1. 更新 `src/graph/config.yaml`，保留单一工作流模板并调整节点映射。
  2. 修改 `templateService` 中的模板映射、错误提示与校验逻辑。
  3. 更新 CLI 文案、帮助信息与 docs（USAGE_GUIDE 等）。
  4. 发布新版本并通知使用者迁移。
- 回滚策略：保留旧配置文件于 `templates/legacy/`；必要时恢复旧模板并回退 CLI 提示。

## 12. 附录
- 参考资料：
  - `src/graph/config.yaml`
  - `src/workflow/templateService.ts`
  - `templates/requirements_template.md`（需求阶段模板）
  - `templates/design_template.md`（设计阶段模板）
  - `templates/implementation_template.md`（实施阶段模板）
- 术语表：
  - “统一工作流”指需求→方案→实施三步结构。
  - “旧模板”指标准 / 功能 / Bug 三套工作流。
- 额外示例：后续在实施阶段提供。
# ADS 设计文档模板

> 填写指引：本模板聚焦助手提示词与交互设计。请使用中文，结合实际场景补充细节，可按需增删小节。

